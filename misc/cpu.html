<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<title>AvaliArch32</title>
	<link rel="stylesheet" href="/assets/styles/bootstrap.min.css">
	<link rel="stylesheet" href="/assets/styles/cpu.css">
</head>

<body>
<main>
	<div class="alert alert-warning disclaimer" role="alert">
		<p>Note: this page is a draft and WiP. It will be released on my official website after the project has been submitted to Open MPW.</p>
	</div>
	<h5>Status:</h5>
	<div class="progress">
		<div class="progress-bar" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width: 10%;"></div>
		<div class="progress-bar-title">Defining initial arch specification</div>
	</div>
	<br>
	<br>
	<br>
	<div class="page-header">
		<h1 style="text-align: center;">AvaliCPU Architecture documentation <small style="color: #aaa;">AvaliArch32</small></h1>
	</div>
	<p>
	AvaliArch32 (AA32) is a 32-bit load/store microprocessor architecture. This page will describe its architecture and instruction set.
	</p>
	<h2>1. Memory</h2>
	<p>AA32 has a single word-addressable logical memory space of 2³² <i>words</i>. A <i>word</i> is defined as 16-bits (2 bytes). A <i>dword</i> is defined as 32-bits, and a <i>qword</i> as 64-bits. The memory is circular, and address calculations exceeding the 2³² limit will wrap around to the beginning of the address space.<br>
	This address space may contain main memory, but may also respond to system I/O devices.</p>
	<h2>2. Registers</h2>
	<p>AA32 defines 64 general-purpose dword-long data registers. Instructions can directly operate on the data stored in these registers, most of which perform a read-modify-write operation. The last 16 of these registers can be incremented and decremented in-place, allowing them to be used as stack pointers.<br>
	As an exception, register r0 is defined as a zero-register, meaning it will always yield the value 0 when read, and writes to it will have no effect, and the written word is discarded. This allows for fast comparisons with 0, and more efficient implementation of data transfer instructions.</p><p>
	Another important register is r1, which is where call instructions will back up the return address, and which holds the address that return instructions will branch to. If a subroutine needs to call further subroutines, a software stack may be used to back up furter return addresses.
	</p><p>
	Additionally, every data register stores its own Carry Flag next to it. The Carry Flag is generated by arithmetic instructions, and will be stored with the register selected as its target. It may be re-used with future arithmetic instructions involving the register.</p><p>
	The architecture also defines 8 predicate registers, each of which holds a boolean value, and may be used as a condition to skip instruction execution. They may be set based on a given condition, such as a CC compare match, or from a register’s Carry Flag. Register p0, similar to r0, also has a fixed value, though in this case, it is always set (True), meaning it is the default predicate to be used for instructions that always execute.</p><p>
	The only other register in the architecture is the program counter, which always points to the next instruction to be executed. It may be set to an explicit value by an instruction, causing program execution to branch. Its value may also be retrieved automatically and written to a memory address just before a branch, enabling subroutine calls.</p>
	<h2 style="margin-left: 5em;">AA32 Registers</h2>
	<table class="regbox" style="width: 29em;">
		<tbody>
			<tr>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
			</tr>
			<tr><td colspan="34"><b>Data registers</b></td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r0</td><td class="reg-c">C</td><td class="reg-name">Zero Register</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r1</td><td class="reg-c">C</td><td class="reg-name">Return address</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r2</td><td class="reg-c">C</td><td class="reg-name">Register 2</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r3</td><td class="reg-c">C</td><td class="reg-name">Register 3</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r4</td><td class="reg-c">C</td><td class="reg-name">Register 4</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" style="background: #333; color: white;" colspan="32">...</td><td class="reg-name" style="text-align: center; background: #333; color:white;" colspan="2">...</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r61</td><td class="reg-c">C</td><td class="reg-name">Register 61</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r62</td><td class="reg-c">C</td><td class="reg-name">Register 62</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r63</td><td class="reg-c">C</td><td class="reg-name">Register 63</td></tr>
		</tbody>
	</table>
	<p style="font-weight: bolder; margin-left: 1.2em; margin-bottom: -0.5em;">
	Predicates</p>
	<table class="regbox" style="width: 14.5em;">
		<tbody>
			<tr class="reg-row"><td class="pred-mnemonic">p0</td><td class="pred-name">Predicate 0</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p1</td><td class="pred-name">Predicate 1</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p2</td><td class="pred-name">Predicate 2</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p3</td><td class="pred-name">Predicate 3</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p4</td><td class="pred-name">Predicate 4</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p5</td><td class="pred-name">Predicate 5</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p6</td><td class="pred-name">Predicate 6</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p7</td><td class="pred-name">Predicate 7</td></tr>
		</tbody>
	</table>
	<table class="regbox" style="width: 29em;">
		<tbody>
			<tr>
				<td>
					<b>Program counter</b>
				</td>
			</tr>
			<tr class="reg-row"><td class="reg-mnemonic">pc</td><td class="reg-name">Program Counter</td></tr>
		</tbody>
	</table>
	<h2>3. Interrupts and traps</h2>
	<p>AA32 has 128 possible interrupts, as encoded in the <code>trap</code> instruction. Upon execution of a trap instruction, the processor will branch to the requested interrupt number, multiplied by 8. Unlike a regular branch, the return address will be backed up in r2. A regular branch instruction can be used to return program execution to the address stored in r2. As the system starts up with interrupts disabled, <code>trap 0</code> may be used as a way to trigger a software reset.<br>Interrupts will be automatically disabled by the trap instruction, and can be re-enabled by executing an <code>ien</code> instruction.</p><p>Upon reception of an interrupt signal, the current instruction execution is completed, and the <code>IACK</code> signal will be asserted by the hardware. The processor will then read one 7-bit word from the system bus, before injecting a <code>trap</code> instruction in the instruction stream, with the interrupt number set to the 7-bits received on the bus. This allows for 128 vectored system interrupts.</p>
	<h2>4. Instruction set</h2>
	<h4>4.1. Instruction types and encoding</h4>
	<p>AA32 features 5 main types of instructions: Register/register (R), Immediate (I), Predicate-management (P), Memory (M), Branch (B) and Jump (J). Every instruction has a fixed length of 42-bits¹, loaded LSB first in two 32-bit data fetches, truncated to 42-bit. All instructions except M-type will operate only on the CPU registers. Only being able to access main memory through M-type load/store instructions makes AA32 a Load/Store class architecture.</p>
	<p>
	All instructions must begin with an 8-bit opcode, followed by a three bit pointer into the predicate register set. The instruction will only execute if the pointed to predicate is True. If it is not, instruction execution is aborted, and the instruction following the current one is loaded.<br>
	This information is followed by the specific argument required by the instruction type. See the table below for a complete list.
	</p>
	<br>
	<p>¹<small>This instruction length was chosen as the most optimal instruction length for the eventual AA32VL architecture, and so used in this predecesor arch.</small></p>
	<table class="formats-table">
		<tbody>
			<tr>
				<th rowspan="2">Format</th>
				<th colspan="42">Bit</th>
			</tr>
			<tr>
				<th>41</th>
				<th>40</th>
				<th>39</th>
				<th>38</th>
				<th>37</th>
				<th>36</th>
				<th>35</th>
				<th>34</th>
				<th>33</th>
				<th>32</th>
				<th>31</th>
				<th>30</th>
				<th>29</th>
				<th>28</th>
				<th>27</th>
				<th>26</th>
				<th>25</th>
				<th>24</th>
				<th>23</th>
				<th>22</th>
				<th>21</th>
				<th>20</th>
				<th>19</th>
				<th>18</th>
				<th>17</th>
				<th>16</th>
				<th>15</th>
				<th>14</th>
				<th>13</th>
				<th>12</th>
				<th>11</th>
				<th>10</th>
				<th>9</th>
				<th>8</th>
				<th>7</th>
				<th>6</th>
				<th>5</th>
				<th>4</th>
				<th>3</th>
				<th>2</th>
				<th>1</th>
				<th>0</th>
			</tr>
			<tr>
				<td>Register/register</td>
				<td colspan="11" class="nop"></td>
				<td colspan="6" class="reg">rs2</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="dest">dst</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
			<tr>
				<td>Immediate</td>
				<td colspan="16" class="imm">imm[15:0]</td>
				<td colspan="1" class="funct">UL</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="dest">dst</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
			<tr>
				<td>Predicate</td>
				<td colspan="11" class="nop"></td>
				<td colspan="6" class="reg">rs2</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="4" class="nop"></td>
				<td colspan="3" class="dest">dst p</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
			<tr>
				<td>Memory</td>
				<td colspan="17" class="imm">imm[16:0]</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="dest">dst</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
			<tr>
				<td>Branch</td>
				<td colspan="17" class="imm">imm[16:0]</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs2</td>
				<td colspan="1" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
			<tr>
				<td>Jump</td>
				<td colspan="17" class="imm">imm[16:0]</td>
				<td colspan="8" class="nop"></td>
				<td colspan="6" class="reg">rs1</td>
				<td colspan="3" class="predicate">p</td>
				<td colspan="8" class="op">opcode</td>
			</tr>
		</tbody>
	</table>
	<br>
	<h4>4.2. Instruction set summary</h4>
	<table class="instructions-table">
		<tr>
			<th rowspan="2">Hi</th>
			<th colspan="16">Lo</th>
		</tr>
		<tr>
			<th>0</th>
			<th>1</th>
			<th>2</th>
			<th>3</th>
			<th>4</th>
			<th>5</th>
			<th>6</th>
			<th>7</th>
			<th>8</th>
			<th>9</th>
			<th>A</th>
			<th>B</th>
			<th>C</th>
			<th>D</th>
			<th>E</th>
			<th>F</th>
		</tr>
		<tr>
			<th>0</th>
			<td class="r-type">NOP</td>
			<td class="r-type">ADD</td>
			<td class="r-type">ADC</td>
			<td class="r-type">SUB</td>
			<td class="r-type">SUC</td>
			<td class="r-type">AND</td>
			<td class="r-type">IOR</td>
			<td class="r-type">XOR</td>
			<td class="r-type">SLC</td>
			<td class="r-type">SRL</td>
			<td class="r-type">SRC</td>
			<td class="r-type">SRR</td>
			<td class="r-type">SAR</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>1</th>
			<td class="i-type">NOP</td>
			<td class="i-type">ADDI</td>
			<td class="i-type">ADCI</td>
			<td class="i-type">SUBI</td>
			<td class="i-type">SUCI</td>
			<td class="i-type">ANDI</td>
			<td class="i-type">IORI</td>
			<td class="i-type">XORI</td>
			<td class="i-type">SLCI</td>
			<td class="i-type">SRLI</td>
			<td class="i-type">SRCI</td>
			<td class="i-type">SRRI</td>
			<td class="i-type">SARI</td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>2</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>3</th>
			<td class="m-type">LD</td>
			<td class="m-type">LDU</td>
			<td class="m-type">LDS</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td class="m-type">STR</td>
			<td class="m-type">STU</td>
			<td class="m-type">STS</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>4</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>5</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>6</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>7</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>8</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>9</th>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>A</th>
			<td class="i-type">SRR</td>
			<td class="i-type">SRW</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>B</th>
			<td class="pr-type">SPC</td>
			<td class="pr-type">SPNC</td>
			<td class="b-type">BRC</td>
			<td class="b-type">BRNC</td>
			<td class="r-type">SC</td>
			<td class="r-type">SNC</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>C</th>
			<td class="pr-type">SPE</td>
			<td class="pr-type">SPNE</td>
			<td class="b-type">BRE</td>
			<td class="b-type">BNE</td>
			<td class="r-type">SE</td>
			<td class="r-type">SNE</td>
			<td class="i-type">SEI</td>
			<td class="i-type">SNEI</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>D</th>
			<td class="pr-type">SPL</td>
			<td class="pr-type">SPNL</td>
			<td class="b-type">BRL</td>
			<td class="b-type">BRNL</td>
			<td class="r-type">SLT</td>
			<td class="r-type">SNLT</td>
			<td class="i-type">SLTI</td>
			<td class="i-type">SNLTI</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>E</th>
			<td class="pr-type">SPG</td>
			<td class="pr-type">SPNG</td>
			<td class="b-type">BRG</td>
			<td class="b-type">BRNG</td>
			<td class="r-type">SGT</td>
			<td class="r-type">SNGT</td>
			<td class="i-type">SGTI</td>
			<td class="i-type">SNGTI</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<th>F</th>
			<td class="pr-type">SPF</td>
			<td class="pr-type">SPT</td>
			<td></td>
			<td class="b-type">BR</td>
			<td class="r-type">CLR</td>
			<td class="r-type">SET</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td class="j-type">JMP</td>
			<td class="j-type">JR</td>
		</tr>
	</table>
</main>
<script src="/assets/js/jquery-3.6.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
</body>
</html>
