<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<title>AvaliArch32</title>
	<link rel="stylesheet" href="/assets/styles/bootstrap.min.css">
	<link rel="stylesheet" href="/assets/styles/cpu.css">
</head>

<body>
<main>
	<div class="alert alert-warning disclaimer" role="alert">
		<p>Note: this page is a draft and WiP. It will be released on my official website after the project has been submitted to Open MPW.</p>
	</div>
	<h5>Status:</h5>
	<div class="progress">
		<div class="progress-bar" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width: 10%;"></div>
		<div class="progress-bar-title">Defining initial arch specification</div>
	</div>
	<br>
	<br>
	<br>
	<div class="page-header">
		<h1 style="text-align: center;">AvaliCPU Architecture documentation <small style="color: #aaa;">AvaliArch32</small></h1>
	</div>
	<p>
	AvaliArch32 (AA32) is a 32-bit load/store microprocessor architecture. This page will describe its architecture and instruction set.
	</p>
	<h2>1. Memory</h2>
	<p>AA32 has a single word-addressable logical memory space of 2³² <i>words</i>. A <i>word</i> is defined as 16-bits (2 bytes). A <i>dword</i> is defined as 32-bits, and a <i>qword</i> as 64-bits. The memory is circular, and address calculations exceeding the 2³² limit will wrap around to the beginning of the address space.<br>
	This address space may contain main memory, but may also respond to system I/O devices.</p>
	<h2>2. Registers</h2>
	<p>AA32 defines 64 general-purpose dword-long data registers. Instructions can directly operate on the data stored in these registers, most of which perform a read-modify-write operation. The last 16 of these registers can be incremented and decremented in-place, allowing them to be used as stack pointers.<br>
	As an exception, register r0 is defined as a zero-register, meaning it will always yield the value 0 when read, and writes to it will have no effect, and the written word is discarded. This allows for fast comparisons with 0, and more efficient implementation of data transfer instructions.</p><p>
	Another important register is r1, which is where call instructions will back up the return address, and which holds the address that return instructions will branch to. If a subroutine needs to call further subroutines, a software stack may be used to back up furter return addresses.
	</p><p>
	Additionally, every data register stores its own Condition Code and Carry Flag next to it. The Carry Flag is generated by arithmetic instructions, and will be stored with the register selected as its target. It may be re-used with future arithmetic instructions involving the register.<br>
	Condition Code is a two-bit flag generated either directly by a compare instruction, or indirectly by a load/store or arithmetic instruction. Its meaning changes depending on the instruction that generated it. The zero-register will always have both CC and C set to 0.</p><p>
	The architecture also defines 8 predicate registers, each of which holds a boolean value, and may be used as a condition to skip instruction execution. They may be set based on a given condition, such as a CC compare match, or from a register’s Carry Flag.</p><p>
	The only other register in the architecture is the program counter, which always points to the next instruction to be executed. It may be set to an explicit value by an instruction, causing program execution to branch. Its value may also be retrieved automatically and written to a memory address just before a branch, enabling subroutine calls.</p>
	<h2 style="margin-left: 5em;">AA32 Registers</h2>
	<table class="regbox" style="width: 29em;">
		<tbody>
			<tr>
				<th>2⁰</th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th>2¹⁶</th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th>2³²</th>
				<th></th>
				<th></th>
				<th></th>
			</tr>
			<tr><td colspan="36"><b>Data registers</b></td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r0</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Zero Register</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r1</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Return address</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r2</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 2</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r3</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 3</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r4</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 4</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" style="background: #333; color: white;" colspan="32">...</td><td class="reg-name" style="text-align: center; background: #333; color:white;" colspan="4">...</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r61</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 61</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r62</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 62</td></tr>
			<tr class="reg-row"><td class="reg-mnemonic" colspan="32">r63</td><td colspan="2">CC</td><td>C</td><td class="reg-name">Register 63</td></tr>
		</tbody>
	</table>
	<p style="font-weight: bolder; margin-left: 1.2em; margin-bottom: -0.5em;">
	Predicates</p>
	<table class="regbox" style="width: 14.5em;">
		<tbody>
			<tr class="reg-row"><td class="pred-mnemonic">p0</td><td class="pred-name">Predicate 0</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p1</td><td class="pred-name">Predicate 1</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p2</td><td class="pred-name">Predicate 2</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p3</td><td class="pred-name">Predicate 3</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p4</td><td class="pred-name">Predicate 4</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p5</td><td class="pred-name">Predicate 5</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p6</td><td class="pred-name">Predicate 6</td></tr>
			<tr class="reg-row"><td class="pred-mnemonic">p7</td><td class="pred-name">Predicate 7</td></tr>
		</tbody>
	</table>
	<table class="regbox" style="width: 29em;">
		<tbody>
			<tr>
				<td>
					<b>Program counter</b>
				</td>
			</tr>
			<tr class="reg-row"><td class="reg-mnemonic">pc</td><td class="reg-name">Program Counter</td></tr>
		</tbody>
	</table>
	<h2>3. Interrupts and traps</h2>
	<p>AA32 has 128 possible interrupts, as encoded in the <code>trap</code> instruction. Upon execution of a trap instruction, the processor will branch to the requested interrupt number, multiplied by 8. Unlike a regular branch, the return address will be backed up in r2 (with the exception of BFAULT). A regular branch instruction can be used to return program execution to the address stored in r2. As the system starts up with interrupts disabled, <code>trap 0</code> may be used as a way to trigger a software reset.<br>Interrupts will be automatically disabled by the trap instruction, and can be re-enabled by executing an <code>ien</code> instruction.</p><p>Upon reception of an interrupt signal, the current instruction execution is completed, and the <code>IACK</code> signal will be asserted by the hardware. The processor will then read one 7-bit word from the system bus, before injecting a <code>trap</code> instruction in the instruction stream, with the interrupt number set to the 7-bits received on the bus. This allows for 128 vectored system interrupts.</p>
</main>
<script src="/assets/js/jquery-3.6.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
</body>
</html>
